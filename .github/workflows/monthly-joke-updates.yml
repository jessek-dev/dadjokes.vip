name: Monthly Joke Updates

on:
  schedule:
    - cron: "0 2 1 * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  update-jokes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          cd scripts
          npm install

      - name: Setup Firebase credentials
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          mkdir -p quotes_app
          echo "$FIREBASE_SERVICE_ACCOUNT" > quotes_app/firebase-service-account.json

      - name: Run incremental update
        id: update
        run: |
          cd scripts
          npm run update 2>&1 | tee update_output.txt
          exit_code=${PIPESTATUS[0]}

          if [ $exit_code -ne 0 ]; then
            echo "Script failed with exit code $exit_code"
            cat update_output.txt
            exit $exit_code
          fi

          if grep -q "No new jokes found" update_output.txt; then
            echo "has_new_jokes=false" >> $GITHUB_OUTPUT
          else
            echo "has_new_jokes=true" >> $GITHUB_OUTPUT
            new_count=$(grep "New jokes added:" update_output.txt | awk '{print $4}')
            sitemap_name=$(grep "New sitemap:" update_output.txt | awk '{print $3}')
            echo "new_joke_count=$new_count" >> $GITHUB_OUTPUT
            echo "sitemap_name=$sitemap_name" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.update.outputs.has_new_jokes == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "Add new jokes from monthly update"
          git push

      - name: Create notification issue
        if: steps.update.outputs.has_new_jokes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const newCount = '${{ steps.update.outputs.new_joke_count }}';
            const sitemapName = '${{ steps.update.outputs.sitemap_name }}';
            const sitemapUrl = 'https://dadjokes.vip/generated_sitemaps/' + sitemapName + '.xml';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'New Sitemap Ready: ' + newCount + ' jokes added',
              body: 'New jokes: ' + newCount + '\nSitemap: ' + sitemapUrl + '\n\nSubmit to Google Search Console',
              labels: ['sitemap']
            });
